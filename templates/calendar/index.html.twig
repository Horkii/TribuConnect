{% extends 'base.html.twig' %}

{% block title %}Calendrier TribuConnect{% endblock %}

{% block body %}
  {% set mois = ['', 'janvier','février','mars','avril','mai','juin','juillet','aoét','septembre','octobre','novembre','décembre'] %}
  {% set shiftLabels = {
    0: 'Repos',
    1: 'Matin',
    2: 'Après-midi',
    3: 'Nuit',
    4: 'Congé',
    5: 'Journée',
    6: 'Télétravail',
    7: 'Déplacement'
  } %}
  {% set shiftColors = {
    0: '#2e7d32',  # Repos - vert
    1: '#4FC3F7',  # Matin - bleu clair
    2: '#1976D2',  # Après-midi - bleu moyen
    3: '#0D47A1',  # Nuit - bleu très foncé
    4: '#00838F',  # Congé - bleu/vert sombre
    5: '#00BCD4',  # Journée - bleu turquoise
    6: '#5C6BC0',  # Télétravail - bleu violacé
    7: '#546E7A'   # Déplacement - bleu/gris
  } %}
  <h1>Calendrier {{ mois[month|date('n')] }} {{ month|date('Y') }}</h1>

  <nav class="calendar-tabs" role="tablist" aria-label="Type de calendrier" style="display:flex; justify-content:center; gap:.35rem; margin:.5rem auto 1rem;">
    <a class="tab {{ tab|default('family') == 'family' ? 'active' : '' }}" href="{{ path('calendar_home', {fid: currentFamily ? currentFamily.id : null, month: month|date('n'), year: month|date('Y'), tab: 'family', view: view|default('month')}) }}#calendar">Calendrier familial</a>
    <a class="tab {{ tab|default('family') == 'work' ? 'active' : '' }}" href="{{ path('calendar_home', {fid: currentFamily ? currentFamily.id : null, month: month|date('n'), year: month|date('Y'), tab: 'work', view: view|default('month')}) }}#calendar">Horaires de travail</a>
  </nav>

  <style>
    /* Onglets de calendrier (blanc/bleu arrondis) */
    .calendar-tabs { display:flex; justify-content:center; align-items:center; gap:.35rem; margin:.5rem auto 1rem; padding:.3rem; background:#fff; border:1px solid #cfd4dc; border-radius:999px; width:fit-content; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .calendar-tabs .tab { display:inline-block; text-decoration:none; padding:.45rem .95rem; border:1px solid transparent; border-radius:999px; color:#0A369D; background:#fff; font-weight:600; transition: background .15s ease, color .15s ease, border-color .15s ease; }
    .calendar-tabs .tab:hover { background:#e9eef7; }
    .calendar-tabs .tab.active { background:#0A369D; color:#fff; border-color:#0A369D; box-shadow: 0 1px 2px rgba(10,54,157,.25) inset; }
    @media (max-width:1024px){ .calendar-tabs { flex-wrap:wrap; padding:.25rem; } .calendar-tabs .tab { padding:.4rem .85rem; font-size:.95rem; } }
    @media (max-width:640px){ .calendar-tabs { gap:.25rem; } .calendar-tabs .tab { padding:.35rem .7rem; font-size:.9rem; } }
    .btn { display:inline-block; text-decoration:none; padding:.45rem .8rem; border:1px solid #0A369D; border-radius:.5rem; background:#0A369D; color:#fff; }
    .btn.danger { background:#e53935; border-color:#e53935; color:#fff; }
    .grid-7 { display:grid; grid-template-columns: repeat(7, 1fr); gap:12px; }
    .card { border:1px solid #e0e4ea; border-radius:.6rem; padding:1rem; background:#fff; }
    .month-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; margin:0 auto; width:100%; }
    .month-grid-wrap { overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .work-form .inline-field { min-width: 0; }

    /* Desktop (>=1024px): cases fixes, méme taille */
    .day-box { display:flex; flex-direction:column; height: 120px; overflow-y: auto; }
    .day-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:.15rem; }
    .day-dow { font-size:.7em; opacity:.7; text-align:right; }
    /* Jusqu'é L (<=1024px): hauteur adaptable par ligne */
    @media (max-width: 1024px) { .day-box { height: auto; min-height: 120px; overflow: visible; } }

    /* Famille: événements compacts (desktop) */
    .month-grid button[popovertarget^="pop-m-"] {
      display:flex; align-items:center; justify-content:flex-start; text-align:left;
      width:100%; min-height:28px; padding:.25rem .4rem; font-size:.8rem;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.1; border-radius:.4rem;
    }
    .month-grid .events { padding-left: 0; }
    .month-grid .events li { margin-bottom:.15rem; }
    .month-grid .badge { font-size:.7em; padding:.05rem .25rem; }
    /* Travail: boutons uniformes (desktop/tablette) */
    .month-grid button[popovertarget^="pop-w-"] {
      display:flex; align-items:center; justify-content:center; text-align:center;
      width:100%; min-height:40px; padding:.35rem .6rem; font-size:.9rem;
      white-space:normal; overflow:visible; text-overflow:clip; line-height:1.2; border-radius:.45rem;
      word-break:break-word; hyphens:auto;
    }

    /* Mobile/tablette: 3 colonnes jusqu'é L */
    @media (max-width: 1024px) {
      .month-grid-wrap { overflow-x: visible; }
      .month-grid { min-width: 0; grid-template-columns: repeat(3, 1fr); margin: 0 auto; }
    }

    /* Masquer l'entéte des jours sur mobile/tablette */
    @media (max-width: 1024px) { .month-grid .dow { display:none !important; } }
    /* Supprimer les puces sur mobile/tablette */
    @media (max-width: 1024px) {
      .month-grid .events { list-style:none !important; padding-left:0 !important; margin-left:0 !important; }
      .month-grid .events li { list-style:none !important; }
    }

    /* Badge du mois sous la grille */
    .calendar-month-footer { display:flex; justify-content:flex-end; margin-top:.5rem; }
    .calendar-month-badge { display:inline-block; background: rgba(10,54,157,.9); color:#fff; padding:.25rem .5rem; border-radius:.35rem; font-weight:600; font-size:.9rem; }

    /* Centrage des titres des sections calendrier */
    #calendar > h3 { text-align:center; }

    /* Nav mois/année responsive et centrée */
    @media (max-width: 1024px) {
      .calendar-controls-below .calendar-nav { grid-template-columns: 1fr 1fr !important; column-gap:.5rem; row-gap:.5rem; }
      .calendar-controls-below .calendar-nav .btn { width:100%; }
      .calendar-controls-below .calendar-nav > div:nth-child(1) { grid-row:1; grid-column:1; text-align:left; }
      .calendar-controls-below .calendar-nav > div:nth-child(4) { grid-row:1; grid-column:2; text-align:right; }
      .calendar-controls-below .calendar-nav > div:nth-child(2) { grid-row:2; grid-column:1; text-align:left; }
      .calendar-controls-below .calendar-nav > div:nth-child(3) { grid-row:2; grid-column:2; text-align:right; }
    }

    /* Téléphone: cartes d'événements empilées (mots à la ligne) */
    @media (max-width: 640px) {
      .month-grid .day-box { padding:.35rem; }
      .month-grid button[popovertarget^="pop-m-"] {
        white-space: normal; overflow: visible; text-overflow: clip;
        display:flex; flex-direction: column; align-items:flex-start; gap:.1rem;
        font-size:.78rem; padding:.25rem .35rem;
      }
      .month-grid button[popovertarget^="pop-m-"] .badge { display:block; }
      .month-grid button[popovertarget^="pop-w-"] {
        display:flex; flex-direction: column; align-items:flex-start; text-align:left;
        white-space: normal; overflow: visible; text-overflow: clip;
        width:100%; min-height:44px; font-size:.8rem !important; padding:.28rem .38rem !important;
      }
    }
    @media (max-width: 640px) {
      .calendar-nav .btn {
        flex-direction: column;
      }
      .calendar-nav .nav-arrow { display:none; }
    }
    /* Full width (full-bleed) section to escape container padding */
    .full-bleed { position: relative; left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw; width: 100vw; }
    /* Uniform nav button sizes across breakpoints */
    .calendar-nav .btn {
      width: 100%;
      min-height: 44px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.35rem;
      text-align:center;
      white-space: nowrap;
    }

    @media (max-width: 640px) {
      .work-form .grid-7 {
        grid-template-columns: 1fr 1fr;
        gap:.5rem;
      }
      .work-form .inline-field {
        grid-column: span 1 !important;
      }
      #workDaysGrid {
        grid-column: span 2 !important;
        grid-template-columns: repeat(3, 1fr) !important;
      }
    }
  </style>

  {# Sélecteur de famille si plusieurs familles #}
  {% if families is defined and families|length > 1 %}
    <form method="get" action="{{ path('calendar_home') }}#calendar" style="margin-bottom:.5rem; display:flex; align-items:center; gap:.5rem; justify-content:center;">
      <input type="hidden" name="view" value="{{ view }}">
      <input type="hidden" name="year" value="{{ month|date('Y') }}">
      <input type="hidden" name="month" value="{{ month|date('n') }}">
      <input type="hidden" name="tab" value="{{ tab }}">
      <label>Famille
        <select name="fid" onchange="this.form.submit()">
          {% for f in families %}
            <option value="{{ f.id }}" {% if currentFamily and f.id == currentFamily.id %}selected{% endif %}>{{ f.name|upper }}</option>
          {% endfor %}
        </select>
      </label>
      <noscript><button class="btn" type="submit">Voir</button></noscript>
    </form>
  {% endif %}

  {# VUE ANNéE (onglet familial) #}
  {% if view == 'year' and tab|default('family') == 'family' %}
    <section id="calendar" style="margin-top:1rem">
      <h3>{{ year }}</h3>
      <div style="display:grid; grid-template-columns: repeat(3,1fr); gap:12px;">
        {% for m in 1..12 %}
          <a class="month-card" href="{{ path('calendar_home', {year: year, month: m, fid: currentFamily ? currentFamily.id : null}) }}#calendar">
            <strong style="display:block; margin-bottom:.35rem;">{{ mois[m] }}</strong>
            <ul style="margin:0; padding-left:1rem; list-style:none;">
              {% for e in yearMonths[m] ?? [] %}
                <li style="font-size:.9em; margin-bottom:.25rem;">{{ e.startAt|date('d') }}: {{ e.title }}</li>
              {% else %}
                <li style="font-size:.9em; opacity:.7;">Aucun événement</li>
              {% endfor %}
            </ul>
          </a>
        {% endfor %}
      </div>
      <div class="year-bottom-nav" style="margin-top:.5rem; display:grid; grid-template-columns: 1fr auto 1fr; align-items:center;">
        <div style="text-align:left">
          <a class="btn" href="{{ path('calendar_home', {view: 'year', year: prevYear, fid: currentFamily ? currentFamily.id : null, tab: tab}) }}#calendar">? Année précédente</a>
        </div>
        <div style="text-align:center">
          <a class="btn" href="{{ path('calendar_home', {year: month|date('Y'), month: month|date('n'), fid: currentFamily ? currentFamily.id : null, tab: tab}) }}#calendar">Retour vue au mois</a>
        </div>
        <div style="text-align:right">
          <a class="btn" href="{{ path('calendar_home', {view: 'year', year: nextYear, fid: currentFamily ? currentFamily.id : null, tab: tab}) }}#calendar">Année suivante ?</a>
        </div>
      </div>
    </section>
  {% else %}
    {# VUE MOIS: FAMILLE OU TRAVAIL #}
    {% if tab|default('family') == 'family' %}
      <section id="calendar" style="margin-top:1rem">
        <h3>{{ mois[month|date('n')] }} {{ month|date('Y') }}</h3>
        <div class="month-grid-wrap"><div class="month-grid">
          {% set days = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'] %}
          {% set shiftLabels = {
            0: 'Repos',
            1: 'Matin',
            2: 'Aprés-midi',
            3: 'Nuit',
            4: 'Congé',
            5: 'Journée',
            6: 'Télétravail',
            7: 'Déplacement'
          } %}
          {% set shiftColors = {
            0: '#2e7d32',
            1: '#039be5',
            2: '#1565c0',
            3: '#0d47a1',
            4: '#00897b',
            5: '#42a5f5',
            6: '#64b5f6',
            7: '#1e88e5'
          } %}
          {% for d in days %}
            <div class="dow" style="text-align:center; font-weight:bold;">{{ d }}</div>
          {% endfor %}
          {% for w in weeks %}
            {% for cell in w %}
              <div class="day-box" style="border:1px solid #ddd; padding:.4rem; opacity: {{ cell.inMonth ? '1' : '.5' }};">
                <div class="day-header">
                  <div class="day-num" style="font-size:.9em; font-weight:bold;">{{ cell.date|date('j') }}</div>
                  <div class="day-dow">
                    {% set dowIndex = cell.date|date('N') %}
                    {{ ['','Lun','Mar','Mer','Jeu','Ven','Sam','Dim'][dowIndex] }}
                  </div>
                </div>
                <ul class="events" style="margin:.25rem 0 0; list-style: none;">
                  {% for e in cell.events %}
                    <li style="font-size:.85em; margin-bottom:.25rem;">
                      {% set pid = 'pop-m-' ~ e.id %}
                      {# ége pour anniversaires: calcule avec date de la case #}
                      {% set bage = null %}
                      {% if e.recurrence == constant('App\\Entity\\Event::RECURRENCE_YEARLY') and currentFamily and currentFamily.members is defined %}
                        {% for m in currentFamily.members %}
                          {% if bage is null and m.birthDate and m.birthDate|date('m') == e.startAt|date('m') and m.birthDate|date('d') == e.startAt|date('d') %}
                            {% set bage = m.birthDate.diff(cell.date).y %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                      <button class="btn" style="padding:.2rem .5rem; font-size:.85em;" popovertarget="{{ pid }}">{{ e.title }}{% if bage is not null %} ({{ bage }} ans){% endif %}
                        <span class="badge start">Déb {{ e.startAt|date('d/m H:i') }}</span>
                        {% if e.endAt %}<span class="badge end">Fin {{ e.endAt|date('d/m H:i') }}</span>{% endif %}
                      </button>
                      <div id="{{ pid }}" popover style="padding:.6rem; max-width:320px; border:1px solid #cfd4dc; border-radius:.6rem;">
                        <div style="font-weight:bold; margin-bottom:.25rem;">{{ e.title }}</div>
                        {% if e.description %}<div style="font-size:.9em;">{{ e.description }}</div>{% endif %}
                        <div style="margin-top:.35rem;">
                          <span class="badge start">Début: {{ e.startAt|date('d/m/Y H:i') }}</span>
                          {% if e.endAt %}<span class="badge end">Fin: {{ e.endAt|date('d/m/Y H:i') }}</span>{% endif %}
                        </div>
                        {% set canDelete = app.user and (e.createdBy and e.createdBy.id == app.user.id) or (currentFamily and currentFamily.owner and currentFamily.owner.id == app.user.id) or is_granted('ROLE_ADMIN') %}
                        {% if canDelete %}
                          <form method="post" action="{{ path('calendar_event_delete', {id: e.id}) }}" onsubmit="return confirm('Supprimer cet événement ?');" style="margin-top:.5rem;">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete_event_' ~ e.id) }}">
                            <button class="btn danger" type="submit">Supprimer</button>
                          </form>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endfor %}
          {% endfor %}
        </div></div>
        <div class="calendar-month-footer"><div class="calendar-month-badge">{{ mois[month|date('n')] }} {{ month|date('Y') }}</div></div>
        <div class="calendar-controls-below" style="margin:.75rem 0;">
          <div style="text-align:center; margin-bottom:.5rem;">
            <a id="chooseMonthBottom" class="btn" href="{{ path('calendar_home', {view: 'year', year: month|date('Y'), fid: currentFamily ? currentFamily.id : null, tab: tab}) }}#calendar">Choisir un mois</a>
          </div>
                    <nav id="calendarNavBottom" class="btnbar calendar-nav" style="margin-bottom: .75rem; display:grid; grid-template-columns: repeat(4, 1fr); gap:.5rem; align-items:center;">
            <div style="text-align:left">
              <a class="btn" href="{{ path('calendar_home', {year: prev|date('Y'), month: prev|date('n'), fid: currentFamily ? currentFamily.id : null, tab: tab, view: view}) }}#calendar">
                <span class="nav-label">Mois précédent</span>
              </a>
            </div>
            <div style="text-align:center">
              <a class="btn" href="{{ path('calendar_home', {year: prevYear, month: month|date('n'), fid: currentFamily ? currentFamily.id : null, tab: tab, view: view}) }}#calendar">
                <span class="nav-label">Année précédente</span>
              </a>
            </div>
            <div style="text-align:center">
              <a class="btn" href="{{ path('calendar_home', {year: nextYear, month: month|date('n'), fid: currentFamily ? currentFamily.id : null, tab: tab, view: view}) }}#calendar">
                <span class="nav-label">Année suivante</span>
              </a>
            </div>
            <div style="text-align:right">
              <a class="btn" href="{{ path('calendar_home', {year: next|date('Y'), month: next|date('n'), fid: currentFamily ? currentFamily.id : null, tab: tab, view: view}) }}#calendar">
                <span class="nav-label">Mois suivant</span>
              </a>
            </div>
          </nav>
        </div>
      </section>
    {% else %}
      {# Onglet TRAVAIL #}
      <section id="calendar" style="margin-top:1rem">
        <h3>Horaires de travail</h3>
        <div class="month-grid-wrap"><div class="month-grid">
          {% set days = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'] %}
          {% for d in days %}
            <div class="dow" style="text-align:center; font-weight:bold;">{{ d }}</div>
          {% endfor %}
          {% for w in weeks %}
            {% for cell in w %}
              {% set key = cell.date|date('Y-m-d') %}
              <div class="day-box" style="border:1px solid #ddd; padding:.4rem; opacity: {{ cell.inMonth ? '1' : '.5' }};">
                <div class="day-header">
                  <div class="day-num" style="font-size:.9em; font-weight:bold;">{{ cell.date|date('j') }}</div>
                  <div class="day-dow">
                    {% set dowIndex = cell.date|date('N') %}
                    {{ ['','Lun','Mar','Mer','Jeu','Ven','Sam','Dim'][dowIndex] }}
                  </div>
                </div>
                <ul class="events" style="margin:.25rem 0 0; list-style:none;">
                  {% for it in workByDay[key]|default([]) %}
                    {% set p = it.pattern %}
                    {% set v = it.value %}
                    {% set label = shiftLabels[v]|default('') %}
                    {% set pid = 'pop-w-' ~ p.id ~ '-' ~ key %}
                    <li style="font-size:.85em; margin-bottom:.25rem;">
                      {% set bg = shiftColors[v]|default('#0d47a1') %}
                      {% set styleBtn = 'background:' ~ bg ~ '; border-color:' ~ bg ~ '; color:#fff;' %}
                      <button class="btn" style="padding:.2rem .5rem; font-size:.85em; {{ styleBtn }}" popovertarget="{{ pid }}">{{ label }} - {{ p.owner.firstName }} {{ p.owner.lastName|upper }}</button>
                      <div id="{{ pid }}" popover style="padding:.6rem; max-width:320px; border:1px solid #cfd4dc; border-radius:.6rem;">
                        <form method="post" action="{{ path('work_update') }}" style="margin:0;">
                          <input type="hidden" name="pattern_id" value="{{ p.id }}">
                          <input type="hidden" name="date" value="{{ key }}">
                          <input type="hidden" name="_token" value="{{ csrf_token('work_update_' ~ p.id ~ '_' ~ key) }}">
                          <label>Modifier&nbsp;
                            <select name="value">
                              <option value="4" {{ v == 4 ? 'selected' : '' }}>Congé</option>
                              <option value="0" {{ v == 0 ? 'selected' : '' }}>Repos</option>
                              <option value="1" {{ v == 1 ? 'selected' : '' }}>Matin</option>
                              <option value="2" {{ v == 2 ? 'selected' : '' }}>Après-midi</option>
                              <option value="3" {{ v == 3 ? 'selected' : '' }}>Nuit</option>
                              <option value="5" {{ v == 5 ? 'selected' : '' }}>Journée</option>
                              <option value="6" {{ v == 6 ? 'selected' : '' }}>Télétravail</option>
                              <option value="7" {{ v == 7 ? 'selected' : '' }}>Déplacement</option>
                            </select>
                          </label>
                          <div style="margin-top:.5rem; text-align:right">
                            <button class="btn" type="submit">Mettre à jour</button>
                          </div>
                        </form>
                      </div>
                    </li>
                  {% else %}
                    <li style="font-size:.8em; opacity:.6;">é</li>
                  {% endfor %}
                </ul>
              </div>
            {% endfor %}
          {% endfor %}
        </div></div>
        <div class="calendar-month-footer"><div class="calendar-month-badge">{{ mois[month|date('n')] }} {{ month|date('Y') }}</div></div>
        <div class="calendar-controls-below" style="margin:.75rem 0;">
          <div style="text-align:center; margin-bottom:.5rem;">
            <a id="chooseMonthBottomWork" class="btn" href="{{ path('calendar_home', {view: 'year', year: month|date('Y'), fid: currentFamily ? currentFamily.id : null, tab: tab}) }}#calendar">Choisir un mois</a>
          </div>
                    <nav id="calendarNavBottomWork" class="btnbar calendar-nav" style="margin-bottom: .75rem; display:grid; grid-template-columns: repeat(4, 1fr); gap:.5rem; align-items:center;">
            <div style="text-align:left">
              <a class="btn" href="{{ path('calendar_home', {year: prev|date('Y'), month: prev|date('n'), fid: currentFamily ? currentFamily.id : null, tab: tab, view: view}) }}#calendar">
                <span class="nav-label">Mois précédent</span>
              </a>
            </div>
            <div style="text-align:center">
              <a class="btn" href="{{ path('calendar_home', {year: prevYear, month: month|date('n'), fid: currentFamily ? currentFamily.id : null, tab: tab, view: view}) }}#calendar">
                <span class="nav-label">Année précédente</span>
              </a>
            </div>
            <div style="text-align:center">
              <a class="btn" href="{{ path('calendar_home', {year: nextYear, month: month|date('n'), fid: currentFamily ? currentFamily.id : null, tab: tab, view: view}) }}#calendar">
                <span class="nav-label">Année suivante</span>
              </a>
            </div>
            <div style="text-align:right">
              <a class="btn" href="{{ path('calendar_home', {year: next|date('Y'), month: next|date('n'), fid: currentFamily ? currentFamily.id : null, tab: tab, view: view}) }}#calendar">
                <span class="nav-label">Mois suivant</span>
              </a>
            </div>
          </nav>
        </div>
      </section>
      <section style="margin-top:1rem">
        <div class="card">
          <h3 style="margin-top:0;">Définir mon rythme de travail</h3>
          {% if workForm %}
            {{ form_start(workForm, { 'attr': {'class': 'work-form'} }) }}
              <div class="grid-7">
                <div class="inline-field" style="grid-column: span 2;">{{ form_row(workForm.cycleLength) }}</div>
                <div class="inline-field start-date-field" style="grid-column: span 2;">{{ form_row(workForm.startDate) }}</div>
                {% set initLen = workForm.cycleLength.vars.value is not empty ? workForm.cycleLength.vars.value : 21 %}
                <div id="workDaysGrid" style="grid-column: span 7; display:grid; gap:.5rem; grid-template-columns: repeat(7, 1fr);">
                  {% for i in 1..21 %}
                    <div class="day-field" data-day="{{ i }}" style="{{ i > initLen ? 'display:none;' : '' }}">{{ form_row(attribute(workForm, 'd' ~ i)) }}</div>
                  {% endfor %}
                </div>
              </div>
              <div style="margin-top:.5rem">
                {{ form_row(workForm.submit) }}
              </div>
            {{ form_end(workForm) }}
            <script>
              (function(){
                var sel = document.getElementById('{{ workForm.cycleLength.vars.id|e('js') }}');
                var grid = document.getElementById('workDaysGrid');
                if (!sel || !grid) return;
                function apply(){
                  var n = parseInt(sel.value, 10) || 21;
                  var items = grid.querySelectorAll('.day-field');
                  items.forEach(function(el){
                    var d = parseInt(el.getAttribute('data-day'),10)||0;
                    el.style.display = (d <= n) ? '' : 'none';
                  });
                }
                sel.addEventListener('change', apply);
                apply();
              })();
            </script>
          {% endif %}
          {% if workPatterns is defined and workPatterns|length > 0 %}
            <p style="margin-top:.75rem;"><small>Rythmes enregistrés:</small></p>
            <ul>
              {% for p in workPatterns %}
                <li style="display:flex; align-items:center; gap:.5rem; justify-content:space-between;">
                  <small>{{ p.owner.firstName }} {{ p.owner.lastName|upper }} é cycle {{ p.cycleLength }}j, début {{ p.startDate|date('d/m/Y') }}</small>
                  {% set canDelete = app.user and (p.owner and p.owner.id == app.user.id) or (currentFamily and currentFamily.owner and currentFamily.owner.id == app.user.id) or is_granted('ROLE_ADMIN') %}
                  {% if canDelete %}
                    <form method="post" action="{{ path('work_pattern_delete', {id: p.id}) }}" onsubmit="return confirm('Supprimer ce rythme ?');" style="margin:0;">
                      <input type="hidden" name="_token" value="{{ csrf_token('work_delete_' ~ p.id) }}">
                      <button class="btn danger" type="submit">Supprimer</button>
                    </form>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </section>
    {% endif %}
  {% endif %}

  {# Formulaire familial en dessous (onglet family uniquement) #}
  {% if tab|default('family') == 'family' %}
  <section style="margin-top:1rem">
    <div class="card">
      <h3 style="margin-top:0;">Ajouter un événement</h3>
      {{ form_start(eventForm) }}
        <div class="grid-7">
          <div style="grid-column: span 3;">{{ form_row(eventForm.title) }}</div>
          <div style="grid-column: span 2;">{{ form_row(eventForm.startAt) }}</div>
          <div style="grid-column: span 2;">{{ form_row(eventForm.endAt) }}</div>
          <div style="grid-column: span 2;">{{ form_row(eventForm.recurrence) }}</div>
          <div style="grid-column: span 5;">{{ form_row(eventForm.description) }}</div>
        </div>
        <div style="margin-top:.5rem">
          <button type="submit" class="btn">Créer l'événement</button>
        </div>
      {{ form_end(eventForm) }}
    </div>
  </section>
  {% endif %}

  <script>
    (function(){
      function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
      function adjustGrid(grid){
        if (!grid) return;
        var isSmall = window.matchMedia('(max-width: 1024px)').matches;
        if (!isSmall) {
          var daysReset = grid.querySelectorAll('.day-box');
          daysReset.forEach(function(day){ day.style.minHeight = ''; });
          var btnsReset = grid.querySelectorAll('.events .btn');
          btnsReset.forEach(function(b){ b.style.fontSize = ''; });
          return;
        }
        var baseMin = 120, perEv = 26, emptyMin = 40, baseFont = 13;
        var boxes = Array.prototype.slice.call(grid.querySelectorAll('.day-box'));
        var cols = 3; // 3 cases par ligne jusqu'é L
        for (var i = 0; i < boxes.length; i += cols) {
          var row = boxes.slice(i, i + cols);
          var maxEv = 0;
          row.forEach(function(day){ var evs = day.querySelectorAll('.events li'); if (evs.length > maxEv) maxEv = evs.length; });
          var rowHeight = (maxEv === 0) ? emptyMin : clamp(baseMin + maxEv * perEv, baseMin, 320);
          row.forEach(function(day){ day.style.minHeight = rowHeight + 'px'; });
          row.forEach(function(day){ var evs = day.querySelectorAll('.events li'); var eCount = evs.length; var px = (eCount > 0) ? clamp(baseFont - (eCount - 1) * 1, 10, baseFont) : baseFont; day.querySelectorAll('.events .btn').forEach(function(b){ b.style.fontSize = px + 'px'; }); });
        }
      }
      function run(){ document.querySelectorAll('.month-grid').forEach(adjustGrid); }
      window.addEventListener('load', run); window.addEventListener('resize', run);
    })();
  </script>
{% endblock %}

